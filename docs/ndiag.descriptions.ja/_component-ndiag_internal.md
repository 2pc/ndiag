ndiagの内部処理
